<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Expense Form</title>
  <link rel="stylesheet" th:href="@{/css/app.css}" />
  <script th:src="@{/js/form-enhance.js}"></script>
  <script>
    function parseNumber(val){
      if(val==null) return 0;
      const digitsOnly = String(val).replace(/[^0-9]/g, '');
      const num = parseInt(digitsOnly || '0', 10);
      return isNaN(num) ? 0 : num;
    }
    function formatCurrency(num){
      const n = Number(num||0);
      return 'Rp. ' + n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function updateTotal() {
        const qty = parseNumber(document.getElementById('quantity').value);
        const priceRaw = parseNumber(document.getElementById('pricePerQuantity').value);
        const total = qty * priceRaw;
        document.getElementById('pricePerQuantity').value = formatCurrency(priceRaw);
        document.getElementById('totalPrice').value = formatCurrency(total);
    }
    window.addEventListener('DOMContentLoaded', function(){
      const price = document.getElementById('pricePerQuantity');
      const total = document.getElementById('totalPrice');
      const qty = document.getElementById('quantity');
      if(price){ price.value = formatCurrency(parseNumber(price.value)); }
      if(total){ total.value = formatCurrency(parseNumber(total.value)); }
      if(qty){ qty.addEventListener('input', updateTotal); }
      if(price){ price.addEventListener('input', updateTotal); }

      const form = document.querySelector('form[method="post"]');
      if(form){
        form.addEventListener('submit', function(){
          // Unformat currency before submit
          const currencyInputs = [price, total];
          currencyInputs.forEach(function(inp){
            if(inp){
              const val = parseNumber(inp.value);
              inp.value = String(val);
            }
          });
        });
      }
    });
  </script>
</head>
<body>
<h2 th:text="${expense.id == null ? 'New Expense' : 'Edit Expense'}"></h2>
<div class="card">
<form th:action="@{/expenses}" method="post">
    <input type="hidden" name="id" th:value="${expense.id}"/>

    <label>Type of Cost</label>
    <input type="text" name="newType" list="typeList" th:value="${expense.expenseType != null ? expense.expenseType.name : ''}" placeholder="Search or enter new type"/>
    <datalist id="typeList">
        <option th:each="type : ${expenseTypes}" th:value="${type.name}"></option>
    </datalist>

    <label>Date</label>
    <input type="date" name="expenseDate" th:value="${expense.expenseDate}"/>

    <label>Description of Goods</label>
    <input type="text" name="product" list="productList" th:value="${expense.product != null ? expense.product.name : ''}" placeholder="Search or enter new product"/>
    <datalist id="productList">
        <option th:each="p : ${productOptions}" th:value="${p.name}"></option>
    </datalist>

    <label>Quantity</label>
    <input type="number" id="quantity" name="quantity" th:value="${expense.quantity}" oninput="updateTotal()"/>

    <label>Price per Quantity</label>
    <input type="text" id="pricePerQuantity" name="pricePerQuantity" th:value="${expense.pricePerQuantity}" class="currency"/>

    <label>Total Price</label>
    <input type="text" id="totalPrice" name="totalPrice" th:value="${expense.totalPrice}" class="currency" readonly/>

    <label>Supplier</label>
    <input type="text" name="supplier" list="supplierList" th:value="${expense.supplier != null ? expense.supplier.name : ''}" placeholder="Search or enter new supplier"/>
    <datalist id="supplierList">
        <option th:each="s : ${supplierOptions}" th:value="${s.name}"></option>
    </datalist>

    <label>Payment Method</label>
    <input type="text" name="paymentMethod" list="paymentList" th:value="${expense.paymentMethod != null ? expense.paymentMethod.name : ''}" placeholder="Search or enter payment method"/>
    <datalist id="paymentList">
        <option th:each="pm : ${paymentMethodOptions}" th:value="${pm.name}"></option>
    </datalist>

    <div class="mt-12">
      <button type="submit">Save</button>
      <a class="button-link" th:href="@{/expenses}">Back</a>
    </div>
</form>
</div>
</body>
</html>
