<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>Product Settlement</title>
<link rel="stylesheet" th:href="@{/css/app.css}" />
<script th:src="@{/js/form-enhance.js}"></script>
<script>
function updateRemaining() {
  const select = document.getElementById('saleSelect');
  const option = select.options[select.selectedIndex];
  const remainingUnits = option ? option.getAttribute('data-remaining-units') : null;
  const totalUnits = option ? option.getAttribute('data-total-units') : null;
  document.getElementById('remainingInfo').textContent = (remainingUnits!=null) ? ('Remaining units: ' + remainingUnits + ' / Total units: ' + totalUnits) : '';
}
window.addEventListener('DOMContentLoaded', function(){
  const select = document.getElementById('saleSelect');
  if (select) updateRemaining();
});
</script>
</head>
<body>
<h2 th:text="${settlement.id == null ? 'New' : 'Edit'} + ' Product Settlement'"></h2>

<form class="toolbar" method="get" th:action="@{/product-settlements/new}">
  <input type="text" name="q" placeholder="Search by product/buyer/company/date" th:value="${param.q}"/>
  <button type="submit">Search</button>
  <a class="button-link" th:href="@{/product-settlements/new}">Clear</a>
</form>

<div class="card">
<form th:action="@{/product-settlements}" th:object="${settlement}" method="post">
    <input type="hidden" th:field="*{id}"/>

    <label>Sale</label>
    <select id="saleSelect" th:field="*{sale.id}" onchange="updateRemaining()">
        <option th:each="s : ${sales}"
                th:value="${s.id}"
                th:with="given=${@productSettlementRepository.sumQuantityGivenBySaleId(s.id)}"
                th:attr="data-total-units=${s.quantity},data-remaining-units=${(s.quantity != null ? s.quantity : 0) - (given != null ? given : 0)}"
                th:text="${(s.code != null ? s.code + ' | ' : '') + (s.product != null ? s.product.name : '') + ' | ' + (s.buyer != null ? s.buyer.name : '') + ' | ' + s.purchaseDate}">
        </option>
    </select>
    <div id="remainingInfo" style="margin:6px 0; font-weight:bold"></div>

    <label>Quantity Given</label>
    <input type="number" min="1" th:field="*{quantityGiven}"/>

    <label>Date Given</label>
    <input type="date" th:field="*{dateGiven}"/>

    <div class="mt-12">
      <button type="submit">Save</button>
      <a class="button-link" th:href="@{/product-settlements}">Back</a>
    </div>
</form>
</div>
</body>
</html>
