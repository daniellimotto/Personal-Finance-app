<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>Sale Form</title>
<link rel="stylesheet" th:href="@{/css/app.css}" />
<script>
function parseNumber(val){
  if(val==null) return 0;
  const digitsOnly = String(val).replace(/[^0-9]/g, '');
  const num = parseInt(digitsOnly || '0', 10);
  return isNaN(num) ? 0 : num;
}
function formatCurrency(num){
  const n = Number(num||0);
  return 'Rp. ' + n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}
function updateTotal() {
  const qty = parseNumber(document.getElementById('quantity').value);
  const priceRaw = parseNumber(document.getElementById('pricePerQuantity').value);
  const total = qty * priceRaw;
  document.getElementById('pricePerQuantity').value = formatCurrency(priceRaw);
  document.getElementById('totalAmount').value = formatCurrency(total);
}
window.addEventListener('DOMContentLoaded', function(){
  const price = document.getElementById('pricePerQuantity');
  const total = document.getElementById('totalAmount');
  const qty = document.getElementById('quantity');
  if(price){ price.value = formatCurrency(parseNumber(price.value)); }
  if(total){ total.value = formatCurrency(parseNumber(total.value)); }
  if(qty){ qty.addEventListener('input', updateTotal); }
  if(price){ price.addEventListener('input', updateTotal); }

  const form = document.querySelector('form[method="post"]');
  if(form){
    form.addEventListener('submit', function(){
      const currencyInputs = [price, total];
      currencyInputs.forEach(function(inp){
        if(inp){
          const val = parseNumber(inp.value);
          inp.value = String(val);
        }
      });
    });
  }
});
</script>
</head>
<body>
<h2 th:text="${sale.id == null ? 'New Sale' : 'Edit Sale'}"></h2>
<div class="card">
<form th:action="@{/sales}" method="post">
    <input type="hidden" name="id" th:value="${sale.id}"/>

    <label>Code</label>
    <input type="text" name="code" th:value="${sale.code}" required/>
    <p th:if="${error}" class="error" th:text="${error}"></p>

    <label>Company</label>
    <input type="text" name="companyName" list="companyList" th:value="${sale.company != null ? sale.company.name : ''}" placeholder="Type or select company"/>
    <datalist id="companyList">
      <option th:each="c : ${companyOptions}" th:value="${c.name}"></option>
    </datalist>

    <label>Buyer</label>
    <input type="text" name="buyerName" list="buyerList" th:value="${sale.buyer != null ? sale.buyer.name : ''}" placeholder="Type or select buyer"/>
    <datalist id="buyerList">
      <option th:each="b : ${buyerOptions}" th:value="${b.name}"></option>
    </datalist>

    <label>Product</label>
    <input type="text" name="productName" list="productList" th:value="${sale.product != null ? sale.product.name : ''}" placeholder="Type or select product"/>
    <datalist id="productList">
      <option th:each="p : ${productOptions}" th:value="${p.name}"></option>
    </datalist>

    <label>Quantity</label>
    <input type="number" id="quantity" name="quantity" th:value="${sale.quantity}" oninput="updateTotal()"/>

    <label>Price per Quantity</label>
    <input type="text" id="pricePerQuantity" name="pricePerQuantity" th:value="${sale.pricePerQuantity}" class="currency"/>

    <label>Total Amount</label>
    <input type="text" id="totalAmount" name="totalAmount" th:value="${sale.totalAmount}" class="currency" readonly/>

    <label>Date</label>
    <input type="date" name="purchaseDate" th:value="${sale.purchaseDate}"/>

    <label>Payment Method</label>
    <input type="text" name="paymentMethod" list="pmList" th:value="${sale.paymentMethod != null ? sale.paymentMethod.name : ''}" placeholder="Type or select method"/>
    <datalist id="pmList">
      <option th:each="pm : ${paymentMethodOptions}" th:value="${pm.name}"></option>
    </datalist>

    <div class="mt-12">
      <button type="submit">Save</button>
      <a class="button-link" th:href="@{/sales}">Back</a>
    </div>
</form>
</div>
</body>
</html>
