<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>Expense Settlement</title>
<script>
function updateRemaining() {
  const select = document.getElementById('expenseSelect');
  const option = select.options[select.selectedIndex];
  const remainingUnits = option ? option.getAttribute('data-remaining-units') : null;
  const totalUnits = option ? option.getAttribute('data-total-units') : null;
  document.getElementById('remainingInfo').textContent = (remainingUnits!=null) ? ('Remaining units: ' + remainingUnits + ' / Total units: ' + totalUnits) : '';
}
window.addEventListener('DOMContentLoaded', function(){
  const select = document.getElementById('expenseSelect');
  if (select) updateRemaining();
});
</script>
</head>
<body>
<h2 th:text="${settlement.id == null ? 'New' : 'Edit'} + ' Expense Settlement'"></h2>

<form method="get" th:action="@{/expense-settlements/new}">
  <input type="text" name="q" placeholder="Search by product, type, or date (YYYY-MM-DD)" th:value="${param.q}"/>
  <button type="submit">Search</button>
  <a th:href="@{/expense-settlements/new}">Clear</a>
</form>

<form th:action="@{/expense-settlements}" th:object="${settlement}" method="post">
    <input type="hidden" th:field="*{id}"/>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    Expense:
    <select id="expenseSelect" th:field="*{expense.id}" onchange="updateRemaining()">
        <option th:each="e : ${expenses}"
                th:value="${e.id}"
                th:with="usedUnits=${@expenseSettlementRepository.sumQuantityUsedByExpenseId(e.id)}"
                th:attr="data-total-units=${e.quantity},data-remaining-units=${(e.quantity != null ? e.quantity : 0) - (usedUnits != null ? usedUnits : 0)}"
                th:text="${e.product.name + ' | ' + e.expenseType.name + ' | ' + e.expenseDate}">
        </option>
    </select>
    <div id="remainingInfo" style="margin:6px 0; font-weight:bold"></div>
    <div th:if="${#fields.hasErrors('expense')}">
      <span style="color:red" th:errors="*{expense}"></span>
    </div>

    Quantity Used: <input type="number" min="1" th:field="*{quantityUsed}"/>
    <div th:if="${#fields.hasErrors('quantityUsed')}">
      <span style="color:red" th:errors="*{quantityUsed}"></span>
    </div>
    <br/>

    Date Used: <input type="date" th:field="*{dateUsed}"/><br/>
    Purpose: <input type="text" th:field="*{purpose}"/><br/>

    <button type="submit">Save</button>
</form>

<a th:href="@{/expense-settlements}">Back</a>
</body>
</html>
